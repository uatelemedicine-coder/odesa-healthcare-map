<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Оперативна карта ЗОЗ Одеської області | 13.12.2025</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: rgba(15, 23, 42, 0.97);
      --bg-card: rgba(30, 41, 59, 0.5);
      --bg-card-hover: #1e293b;
      --border-color: #1e293b;
      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --accent-green-light: #4ade80;
      --accent-red: #ef4444;
      --accent-red-light: #f87171;
      --accent-amber: #fbbf24;
      --accent-orange: #f97316;
      --input-bg: #1e293b;
      --input-border: #334155;
      --shadow-color: rgba(0,0,0,0.4);
    }
    [data-theme="light"] {
      --bg-primary: #f1f5f9;
      --bg-secondary: rgba(255, 255, 255, 0.97);
      --bg-card: rgba(241, 245, 249, 0.8);
      --bg-card-hover: #e2e8f0;
      --border-color: #cbd5e1;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --input-bg: #ffffff;
      --input-border: #cbd5e1;
      --shadow-color: rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; transition: background 0.3s, color 0.3s; }
    #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    .header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: linear-gradient(to bottom, var(--bg-primary), var(--bg-primary), transparent); padding: 12px 16px 40px; pointer-events: none; }
    .header-content { display: flex; align-items: center; gap: 12px; pointer-events: auto; }
    .logo { width: 44px; height: 44px; background: linear-gradient(135deg, #fbbf24, #f97316); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3); }
    .logo svg { width: 26px; height: 26px; color: white; }
    .header-text h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    .header-text p { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
    
    .controls-panel { position: fixed; top: 16px; right: 400px; z-index: 1002; display: flex; gap: 8px; }
    .control-group { background: var(--bg-card); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; display: flex; gap: 4px; }
    .control-group button { width: 36px; height: 36px; border: none; border-radius: 8px; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .control-group button:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .control-group button.active { background: var(--accent-blue); color: white; }
    .control-group button.active-orange { background: var(--accent-orange); color: white; }
    
    .sidebar { position: fixed; top: 0; right: 0; width: 380px; height: 100%; background: var(--bg-secondary); backdrop-filter: blur(20px); border-left: 1px solid var(--border-color); z-index: 1001; display: flex; flex-direction: column; transform: translateX(0); transition: transform 0.3s, background 0.3s; }
    .sidebar.hidden { transform: translateX(100%); }
    .sidebar-header { padding-top: 70px; }
    .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab:hover { color: var(--text-primary); background: var(--bg-card); }
    .tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
    .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-content.active { display: flex; }
    .district-overview { padding: 16px; overflow-y: auto; flex: 1; }
    .district-card { padding: 14px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color); background: var(--bg-card); }
    .district-card:hover { transform: translateX(4px); border-color: var(--accent-blue); }
    .district-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .district-card-name { font-size: 15px; font-weight: 600; }
    .district-card-status { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 20px; }
    .district-card-status.power-yes { background: rgba(250, 204, 21, 0.15); color: #facc15; }
    .district-card-status.power-partial { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .district-card-status.power-no { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .district-card-status .dot { width: 8px; height: 8px; border-radius: 50%; }
    .district-card-status.power-yes .dot { background: #facc15; }
    .district-card-status.power-partial .dot { background: #f97316; }
    .district-card-status.power-no .dot { background: #3b82f6; }
    .district-card-stats { display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary); }
    .district-card-stats span { display: flex; align-items: center; gap: 4px; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 16px; border-bottom: 1px solid var(--border-color); }
    .stat-card { padding: 12px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; background: var(--bg-card); }
    .stat-card:hover { background: var(--bg-card-hover); }
    .stat-card.active { border-color: rgba(59, 130, 246, 0.5); background: rgba(59, 130, 246, 0.1); }
    .stat-card.active-green { border-color: rgba(34, 197, 94, 0.5); background: rgba(34, 197, 94, 0.1); }
    .stat-card.active-red { border-color: rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.1); }
    .stat-number { font-size: 28px; font-weight: 700; }
    .stat-number.green { color: var(--accent-green-light); }
    .stat-number.red { color: var(--accent-red-light); }
    .stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
    .filters { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
    .search-box { position: relative; }
    .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-muted); }
    .search-box input { width: 100%; padding: 10px 12px 10px 40px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; outline: none; transition: border-color 0.2s, background 0.3s; }
    .search-box input:focus { border-color: var(--accent-blue); }
    .search-box input::placeholder { color: var(--text-muted); }
    select { width: 100%; padding: 10px 12px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 10px; color: var(--text-primary); font-size: 14px; outline: none; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px; transition: background 0.3s; }
    select:focus { border-color: var(--accent-blue); }
    .facility-list { flex: 1; overflow-y: auto; }
    .facility-item { padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; display: flex; gap: 12px; align-items: flex-start; }
    .facility-item:hover { background: var(--bg-card); }
    .facility-status { width: 10px; height: 10px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
    .facility-status.on { background: var(--accent-green); }
    .facility-status.off { background: var(--accent-red); }
    .facility-info { flex: 1; min-width: 0; }
    .facility-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .facility-meta { font-size: 12px; color: var(--text-muted); margin-top: 3px; }
    .facility-tags { display: flex; gap: 8px; margin-top: 6px; font-size: 11px; color: var(--text-secondary); }
    .facility-tags span.heat { color: var(--accent-amber); }
    .facility-arrow { color: var(--text-muted); flex-shrink: 0; margin-top: 4px; }
    .detail-view { padding: 16px; display: none; flex-direction: column; gap: 16px; overflow-y: auto; flex: 1; }
    .detail-view.active { display: flex; }
    .back-btn { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: color 0.2s; background: none; border: none; }
    .back-btn:hover { color: var(--text-primary); }
    .detail-header h2 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .detail-header p { font-size: 13px; color: var(--text-muted); }
    .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; font-size: 13px; font-weight: 500; }
    .status-badge.on { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: var(--accent-green-light); }
    .status-badge.off { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--accent-red-light); }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
    .status-badge.on .status-dot { background: var(--accent-green); }
    .status-badge.off .status-dot { background: var(--accent-red); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .info-grid { display: flex; flex-direction: column; gap: 8px; }
    .info-row { display: flex; gap: 12px; padding: 12px; background: var(--bg-card); border-radius: 10px; }
    .info-icon { font-size: 16px; flex-shrink: 0; }
    .info-content { flex: 1; min-width: 0; }
    .info-label { font-size: 11px; color: var(--text-muted); margin-bottom: 2px; }
    .info-value { font-size: 13px; color: var(--text-secondary); word-break: break-word; }
    .sidebar-footer { padding: 12px 16px; border-top: 1px solid var(--border-color); text-align: center; background: var(--bg-secondary); }
    .sidebar-footer p { font-size: 11px; color: var(--text-muted); }
    .legend { position: fixed; bottom: 16px; left: 16px; background: var(--bg-secondary); backdrop-filter: blur(10px); border-radius: 12px; border: 1px solid var(--border-color); padding: 12px 16px; z-index: 1000; }
    .legend-title { font-size: 11px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .legend-section { margin-bottom: 10px; }
    .legend-section:last-child { margin-bottom: 0; }
    .legend-section-title { font-size: 10px; color: var(--text-muted); margin-bottom: 6px; }
    .legend-items { display: flex; flex-direction: column; gap: 6px; }
    .legend-item { display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 12px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .legend-dot.green { background: var(--accent-green); }
    .legend-dot.red { background: var(--accent-red); }
    .legend-rect { width: 20px; height: 12px; border-radius: 3px; opacity: 0.7; }
    .legend-rect.yellow { background: #facc15; }
    .legend-rect.orange { background: #f97316; }
    .legend-rect.blue { background: #3b82f6; }
    .toggle-btn { display: none; position: fixed; bottom: 16px; right: 16px; width: 56px; height: 56px; background: var(--accent-blue); border-radius: 50%; border: none; color: white; z-index: 1002; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4); cursor: pointer; }
    .empty-state { padding: 48px 16px; text-align: center; color: var(--text-muted); }
    .empty-state .icon { font-size: 40px; margin-bottom: 8px; }
    .leaflet-popup-content-wrapper { background: var(--bg-card-hover); border-radius: 12px; box-shadow: 0 10px 40px var(--shadow-color); }
    .leaflet-popup-content { margin: 12px; color: var(--text-primary); font-family: 'Inter', sans-serif; }
    .leaflet-popup-tip { background: var(--bg-card-hover); }
    .leaflet-container { background: var(--bg-primary); }
    .popup-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .popup-district { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
    .popup-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
    .popup-status.on { background: rgba(34, 197, 94, 0.15); color: var(--accent-green-light); }
    .popup-status.off { background: rgba(239, 68, 68, 0.15); color: var(--accent-red-light); }
    .popup-status span { width: 6px; height: 6px; border-radius: 50%; }
    .popup-status.on span { background: var(--accent-green); }
    .popup-status.off span { background: var(--accent-red); }
    .data-source { position: fixed; top: 70px; left: 16px; background: var(--bg-secondary); backdrop-filter: blur(10px); border-radius: 8px; border: 1px solid var(--border-color); padding: 8px 12px; z-index: 1000; font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .data-source .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
    .district-label { background: transparent !important; border: none !important; box-shadow: none !important; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 700; color: var(--text-primary); text-shadow: 0 1px 4px rgba(0,0,0,0.9), 0 0 12px rgba(0,0,0,0.7); white-space: nowrap; }
    @media (max-width: 768px) { .sidebar { width: 100%; } .toggle-btn { display: flex; align-items: center; justify-content: center; } .controls-panel { right: 16px; top: auto; bottom: 80px; flex-direction: column; } }
  </style>
</head>
<body>
  <div id="map"></div>
  <header class="header">
    <div class="header-content">
      <div class="logo"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg></div>
      <div class="header-text"><h1>Оперативна карта ЗОЗ</h1><p>Одеська область • 13.12.2025</p></div>
    </div>
  </header>
  
  <div class="controls-panel">
    <div class="control-group" title="Тема">
      <button id="darkBtn" class="active" onclick="setTheme('dark')" title="Темна тема">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
      </button>
      <button id="lightBtn" onclick="setTheme('light')" title="Світла тема">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
      </button>
    </div>
    <div class="control-group" title="Заливка районів">
      <button id="colorBtn" class="active-orange" onclick="toggleDistrictColors()" title="Показати/сховати заливку районів">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
      </button>
    </div>
  </div>
  
  <div class="data-source" id="dataSource"><div class="dot"></div><span>Локальні дані</span></div>
  
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('districts')">Райони</div>
        <div class="tab" onclick="switchTab('facilities')">Заклади</div>
      </div>
    </div>
    <div class="tab-content active" id="tabDistricts">
      <div class="district-overview" id="districtOverview"></div>
    </div>
    <div class="tab-content" id="tabFacilities">
      <div class="stats-grid">
        <div class="stat-card active" id="statAll" onclick="setFilter('all')"><div class="stat-number" id="totalCount">0</div><div class="stat-label">Всього</div></div>
        <div class="stat-card" id="statOn" onclick="setFilter('on')"><div class="stat-number green" id="onCount">0</div><div class="stat-label">Зі світлом</div></div>
        <div class="stat-card" id="statOff" onclick="setFilter('off')"><div class="stat-number red" id="offCount">0</div><div class="stat-label">Без світла</div></div>
      </div>
      <div class="filters">
        <div class="search-box">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
          <input type="text" id="searchInput" placeholder="Пошук закладу..." oninput="filterFacilities()">
        </div>
        <select id="districtSelect" onchange="filterFacilities()"><option value="">Всі райони</option></select>
      </div>
      <div class="facility-list" id="facilityList"></div>
      <div class="detail-view" id="detailView">
        <button class="back-btn" onclick="hideDetail()"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>Назад до списку</button>
        <div class="detail-header"><h2 id="detailName"></h2><p id="detailFullName"></p></div>
        <div id="detailStatus"></div>
        <div class="info-grid" id="detailInfo"></div>
      </div>
    </div>
    <div class="sidebar-footer"><p>Дані станом на 13.12.2025 • КНП "ООКЛ" ОДА</p></div>
  </aside>
  
  <div class="legend">
    <div class="legend-title">Умовні позначення</div>
    <div class="legend-section">
      <div class="legend-section-title">Райони (електропостачання)</div>
      <div class="legend-items">
        <div class="legend-item"><div class="legend-rect yellow"></div><span>Є світло</span></div>
        <div class="legend-item"><div class="legend-rect orange"></div><span>Частково</span></div>
        <div class="legend-item"><div class="legend-rect blue"></div><span>Немає світла</span></div>
      </div>
    </div>
    <div class="legend-section">
      <div class="legend-section-title">Заклади</div>
      <div class="legend-items">
        <div class="legend-item"><div class="legend-dot green"></div><span>Зі світлом</span></div>
        <div class="legend-item"><div class="legend-dot red"></div><span>Без світла</span></div>
      </div>
    </div>
  </div>
  
  <button class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">
    <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
  </button>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const CONFIG = { USE_GOOGLE_SHEETS: false, GOOGLE_SHEETS_URL: '', REFRESH_INTERVAL: 300000 };

    // СТАТУС ЕЛЕКТРОПОСТАЧАННЯ РАЙОНІВ
    const districtPowerStatus = {
      'Одеський': 'partial',
      'Білгород-Дністровський': 'yes',
      'Ізмаїльський': 'no',
      'Болградський': 'yes',
      'Роздільнянський': 'partial',
      'Подільський': 'partial',
      'Березівський': 'no'
    };

    const districtColors = { 'yes': '#facc15', 'partial': '#f97316', 'no': '#3b82f6' };
    const districtStatusLabels = { 'yes': 'Є світло', 'partial': 'Частково', 'no': 'Немає світла' };

    // ТОЧНІ МЕЖІ 7 РАЙОНІВ ОДЕСЬКОЇ ОБЛАСТІ (на основі карти адмінреформи 2020)
    const districtPolygons = {
      // ПОДІЛЬСЬКИЙ - на півночі (центр: Подільськ)
      'Подільський': {
        type: 'Polygon',
        coordinates: [[
          [28.85, 48.18], [29.05, 48.22], [29.25, 48.20], [29.45, 48.15], [29.65, 48.05],
          [29.85, 47.95], [30.05, 47.85], [30.20, 47.70], [30.25, 47.55], [30.20, 47.40],
          [30.10, 47.25], [29.95, 47.15], [29.75, 47.10], [29.55, 47.10], [29.35, 47.15],
          [29.15, 47.25], [29.00, 47.40], [28.90, 47.55], [28.80, 47.75], [28.75, 47.95],
          [28.80, 48.10], [28.85, 48.18]
        ]]
      },
      // БЕРЕЗІВСЬКИЙ - на північному сході (центр: Березівка)
      'Березівський': {
        type: 'Polygon',
        coordinates: [[
          [30.25, 47.55], [30.45, 47.60], [30.70, 47.58], [30.95, 47.50], [31.15, 47.38],
          [31.30, 47.22], [31.38, 47.05], [31.35, 46.88], [31.25, 46.72], [31.10, 46.60],
          [30.90, 46.55], [30.70, 46.58], [30.50, 46.65], [30.35, 46.75], [30.25, 46.88],
          [30.18, 47.05], [30.15, 47.22], [30.18, 47.38], [30.25, 47.55]
        ]]
      },
      // РОЗДІЛЬНЯНСЬКИЙ - в центрі (центр: Роздільна)
      'Роздільнянський': {
        type: 'Polygon',
        coordinates: [[
          [29.55, 47.10], [29.75, 47.10], [29.95, 47.05], [30.15, 46.95], [30.25, 46.85],
          [30.30, 46.72], [30.28, 46.58], [30.20, 46.45], [30.05, 46.35], [29.85, 46.30],
          [29.65, 46.32], [29.45, 46.40], [29.30, 46.52], [29.22, 46.68], [29.20, 46.85],
          [29.25, 47.00], [29.35, 47.08], [29.55, 47.10]
        ]]
      },
      // ОДЕСЬКИЙ - на сході біля моря (центр: Одеса)
      'Одеський': {
        type: 'Polygon',
        coordinates: [[
          [30.20, 46.92], [30.35, 46.95], [30.55, 46.92], [30.75, 46.85], [30.95, 46.72],
          [31.10, 46.55], [31.18, 46.38], [31.15, 46.20], [31.05, 46.02], [30.88, 45.88],
          [30.65, 45.82], [30.42, 45.85], [30.22, 45.95], [30.05, 46.08], [29.92, 46.25],
          [29.85, 46.42], [29.88, 46.58], [29.98, 46.72], [30.10, 46.85], [30.20, 46.92]
        ]]
      },
      // БІЛГОРОД-ДНІСТРОВСЬКИЙ - на півдні біля моря (центр: Білгород-Дністровський)
      'Білгород-Дністровський': {
        type: 'Polygon',
        coordinates: [[
          [29.15, 46.32], [29.35, 46.35], [29.55, 46.30], [29.75, 46.20], [29.92, 46.05],
          [30.05, 45.88], [30.10, 45.70], [30.05, 45.52], [29.90, 45.38], [29.68, 45.28],
          [29.42, 45.25], [29.18, 45.32], [28.98, 45.45], [28.85, 45.62], [28.80, 45.82],
          [28.85, 46.00], [28.95, 46.15], [29.08, 46.28], [29.15, 46.32]
        ]]
      },
      // БОЛГРАДСЬКИЙ - на південному заході (центр: Болград)
      'Болградський': {
        type: 'Polygon',
        coordinates: [[
          [28.10, 46.28], [28.32, 46.35], [28.55, 46.32], [28.78, 46.22], [28.95, 46.08],
          [29.05, 45.90], [29.08, 45.70], [29.00, 45.52], [28.85, 45.38], [28.62, 45.28],
          [28.38, 45.25], [28.15, 45.32], [27.95, 45.48], [27.82, 45.68], [27.78, 45.90],
          [27.85, 46.08], [27.98, 46.22], [28.10, 46.28]
        ]]
      },
      // ІЗМАЇЛЬСЬКИЙ - на півдні (центр: Ізмаїл)
      'Ізмаїльський': {
        type: 'Polygon',
        coordinates: [[
          [28.38, 45.25], [28.62, 45.28], [28.85, 45.22], [29.05, 45.12], [29.22, 44.98],
          [29.32, 44.82], [29.35, 44.65], [29.28, 44.50], [29.12, 44.40], [28.90, 44.35],
          [28.65, 44.38], [28.42, 44.48], [28.22, 44.62], [28.08, 44.80], [28.00, 45.00],
          [28.05, 45.18], [28.18, 45.28], [28.38, 45.25]
        ]]
      }
    };

    const districtInfo = {
      'Одеський': { population: '1360.9 тис.', center: [46.35, 30.55], zoom: 9, labelPos: [46.25, 30.65] },
      'Білгород-Дністровський': { population: '201.4 тис.', center: [45.75, 29.45], zoom: 9, labelPos: [45.70, 29.50] },
      'Ізмаїльський': { population: '206.2 тис.', center: [44.85, 28.70], zoom: 9, labelPos: [44.80, 28.70] },
      'Болградський': { population: '154.5 тис.', center: [45.75, 28.45], zoom: 9, labelPos: [45.75, 28.35] },
      'Роздільнянський': { population: '104.2 тис.', center: [46.70, 29.75], zoom: 9, labelPos: [46.70, 29.75] },
      'Подільський': { population: '229.9 тис.', center: [47.65, 29.50], zoom: 8, labelPos: [47.55, 29.50] },
      'Березівський': { population: '123.3 тис.', center: [47.05, 30.75], zoom: 9, labelPos: [47.05, 30.80] }
    };

    let facilitiesData = [
      // ОДЕСЬКИЙ РАЙОН
      { id: 1, name: 'КНП "Одеська обласна клінічна лікарня"', shortName: 'Обласна клінічна лікарня', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори, сонячні панелі, ДБЖ', fuelReserve: '7 діб', heating: 'власна котельня', water: 'власна свердловина', waterReserve: '100000 л', communication: 'Наявний', damages: 'ні', contact: 'Ляшенко Артем Володимирович 0668035861', lat: 46.4775, lng: 30.7326 },
      { id: 2, name: 'КНП "Одеська обласна дитяча клінічна лікарня"', shortName: 'Обласна дитяча лікарня', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори, сонячні панелі, ДБЖ', fuelReserve: '5 діб', heating: 'власна котельня', water: 'централізоване', waterReserve: '90000 техн. / 2700 питна', communication: 'Є', damages: 'ні', contact: 'Чіхварія Хвіча Отарович 0674838818', lat: 46.4695, lng: 30.7456 },
      { id: 3, name: 'КНП "Одеський обласний клінічний медичний центр"', shortName: 'Обласний мед. центр', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Сонячні батареї', fuelReserve: '20 діб', heating: 'відсутнє', water: 'відсутнє', waterReserve: '5 л', communication: 'Є', damages: 'ні', contact: 'Ткач В.А. 097 615 4722', lat: 46.4825, lng: 30.7216 },
      { id: 4, name: 'КНП "Багатопрофільний шпиталь ветеранів"', shortName: 'Шпиталь ветеранів', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори, ДБЖ', fuelReserve: '5 діб', heating: 'централізоване, наявне', water: 'централізоване, наявне', waterReserve: '5000 техн. / 1000 питна', communication: 'Є', damages: 'ні', contact: 'Жукова Ірина 0930690099', lat: 46.4655, lng: 30.7586 },
      { id: 5, name: 'КНП "Одеський обласний центр соціально значущих хвороб"', shortName: 'Центр соц. значущих хвороб', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'часткове', water: 'часткове', waterReserve: '1000 л', communication: 'Є', damages: 'відсутні', contact: 'Філатенкова Анастасія 0677428025', lat: 46.4545, lng: 30.7126 },
      { id: 6, name: 'КНП "Одеський обласний центр нефрології та діалізу"', shortName: 'Центр нефрології та діалізу', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори', fuelReserve: '20 діб', heating: 'централізоване, відсутнє', water: 'централізоване, відсутнє', waterReserve: '6000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Блохіна А.С 0983882000', lat: 46.4635, lng: 30.7406 },
      { id: 7, name: 'КНП "Одеський регіональний клінічний протипухлинний центр"', shortName: 'Протипухлинний центр', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'централізоване, наявне', water: 'централізоване, немає', waterReserve: '8000 техн. / 1000 питна', communication: 'Наявний', damages: 'немає', contact: 'Стефанов Рустам 0503367576', lat: 46.4515, lng: 30.7256 },
      { id: 8, name: 'КНП "Одеська обласна станція переливання крові"', shortName: 'Станція переливання крові', district: 'Одеський', type: 'Обласний заклад', hasElectricity: false, alternativePower: 'Генератори (ДГА-100)', fuelReserve: '5 діб', heating: 'централізоване, наявне', water: 'централізоване, наявне', waterReserve: '4000 техн. / 1000 питна', communication: 'Наявний', damages: 'відсутні', contact: 'Ткаченко Марина 0979395274', lat: 46.4725, lng: 30.7176 },
      { id: 16, name: 'КНП "Міська клінічна лікарня № 10"', shortName: 'МКЛ № 10', district: 'Одеський', type: 'Міська лікарня', hasElectricity: false, alternativePower: 'Генератори, Tesla', fuelReserve: '30% (поповнення)', heating: 'відсутнє', water: 'свердловина', waterReserve: 'Необмежений', communication: 'Наявний', damages: 'відсутні', contact: 'Сергій Ошовський +380671655291', lat: 46.4255, lng: 30.7656 },
      { id: 25, name: 'КНП "Дитяча міська клінічна лікарня № 3"', shortName: 'Дитяча МКЛ № 3', district: 'Одеський', type: 'Дитяча лікарня', hasElectricity: false, alternativePower: 'Генератори, сонячні панелі, Tesla, ДБЖ', fuelReserve: 'Постійне поповнення', heating: 'централізоване, наявне', water: 'часткове', waterReserve: '16700 л', communication: 'Наявний', damages: 'відсутні', contact: 'Бурега Людмила 0964248612', lat: 46.3955, lng: 30.6956 },
      { id: 26, name: 'КНП "Міська клінічна інфекційна лікарня"', shortName: 'Інфекційна лікарня', district: 'Одеський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератор, сонячні панелі', fuelReserve: 'Обслуговує Міськсвітло', heating: 'власна котельня ТГО', water: 'є, низький тиск + свердловина', waterReserve: '6000 л', communication: 'Є', damages: 'немає', contact: 'Лаврюкова Світлана 0503337959', lat: 46.4355, lng: 30.7556 },
      { id: 28, name: 'КНП "Дитяча міська поліклініка № 3"', shortName: 'Дитяча поліклініка № 3', district: 'Одеський', type: 'Поліклініка', hasElectricity: false, alternativePower: 'Генератор, акумуляторний генератор', fuelReserve: '5 днів', heating: 'централізоване, є', water: 'централізоване, є', waterReserve: 'Є', communication: 'Є', damages: 'ні', contact: 'Мармусевич Лариса 0662548255', lat: 46.4455, lng: 30.7856 },
      { id: 15, name: 'КНП "Чорноморська лікарня"', shortName: 'Чорноморська лікарня', district: 'Одеський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '7 діб', heating: 'централізоване', water: 'централізоване', waterReserve: '25000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Андрєєв Юрій 063 726 2404', lat: 46.3039, lng: 30.6553 },
      { id: 20, name: 'КНП "Овідіопольська лікарня"', shortName: 'Овідіопольська лікарня', district: 'Одеський', type: 'Селищна лікарня', hasElectricity: false, alternativePower: 'Генератори, акумулятори', fuelReserve: '5-7 днів', heating: 'власна котельня (газ + дрова)', water: 'централізоване', waterReserve: '3000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Салата Тетяна 0966148862', lat: 46.2500, lng: 30.4500 },
      { id: 27, name: 'КНП "Великодолинський консультативно-діагностичний центр"', shortName: 'Великодолинський КДЦ', district: 'Одеський', type: 'Діагностичний центр', hasElectricity: false, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'власна котельня', water: 'централізоване (відсутнє)', waterReserve: '26000 л', communication: 'Мобільний', damages: 'немає', contact: 'Бєлємук Олена 0972859399', lat: 46.3667, lng: 30.5833 },
      { id: 29, name: 'КНП "Грибівська амбулаторія ЗПСМ"', shortName: 'Грибівська амбулаторія', district: 'Одеський', type: 'Амбулаторія', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '5 днів', heating: 'власна котельня', water: 'комунальна свердловина', waterReserve: '2000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Плохотнюк Павло +380679372845', lat: 46.3333, lng: 30.4667 },
      { id: 32, name: 'КНП "Теплодарський центр ПМСД"', shortName: 'Теплодарський ЦПМСД', district: 'Одеський', type: 'ЦПМСД', hasElectricity: false, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'централізоване (ні)', water: 'централізоване (так)', waterReserve: '760 л', communication: 'Є', damages: 'відсутні', contact: 'Цимбалюк Оксана 0974962775', lat: 46.5000, lng: 30.3333 },
      { id: 33, name: 'КНП "ЦПМСД Яськівської сільської ради"', shortName: 'Яськівський ЦПМСД', district: 'Одеський', type: 'ЦПМСД', hasElectricity: false, alternativePower: 'Генератори, сонячні панелі', fuelReserve: '5 діб', heating: 'власна котельня', water: 'наявне', waterReserve: '2000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Курко Денис 0960932774', lat: 46.6000, lng: 30.2500 },
      { id: 34, name: 'КНП "Овідіопольський центр ПМСД"', shortName: 'Овідіопольський ЦПМСД', district: 'Одеський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'котельня', water: 'наявне', waterReserve: '300 л', communication: 'Є', damages: 'ні', contact: 'Кабальська Оксана', lat: 46.2667, lng: 30.4333 },
      // БІЛГОРОД-ДНІСТРОВСЬКИЙ РАЙОН
      { id: 11, name: 'КНП "Білгород-Дністровська міська багатопрофільна лікарня"', shortName: 'Б-Дністровська міська лікарня', district: 'Білгород-Дністровський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератори, акумулятори, ДБЖ', fuelReserve: '7 діб', heating: 'центральна котельня', water: 'централізоване', waterReserve: '18000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Жнякін Віталій 0977226393', lat: 46.1958, lng: 30.3461 },
      { id: 30, name: 'КНП "Татарбунарський районний центр ПМСД"', shortName: 'Татарбунарський ЦПМСД', district: 'Білгород-Дністровський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори, сонячні панелі', fuelReserve: '7 діб', heating: 'місцеві котельні', water: 'наявне', waterReserve: '5 днів', communication: 'Наявний', damages: 'відсутні', contact: 'Стогній С.В. 0962601962', lat: 45.8500, lng: 29.6167 },
      { id: 31, name: 'КП "Саратський центр ПМСД"', shortName: 'Саратський ЦПМСД', district: 'Білгород-Дністровський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '10 днів', heating: 'централізоване', water: 'централізоване', waterReserve: '2 дні', communication: 'Наявний', damages: 'ні', contact: 'Грибенко Сергій 0971896450', lat: 46.0167, lng: 29.6667 },
      // ІЗМАЇЛЬСЬКИЙ РАЙОН
      { id: 12, name: 'КНП "Кілійська багатопрофільна лікарня"', shortName: 'Кілійська лікарня', district: 'Ізмаїльський', type: 'Міська лікарня', hasElectricity: false, alternativePower: 'Генератор', fuelReserve: '7 діб', heating: 'автономне (вугільні котли)', water: 'централізоване + резерв', waterReserve: '41000 л', communication: 'Мобільний', damages: 'відсутні', contact: "Жур'ян Василій 0972174231", lat: 45.4422, lng: 29.2672 },
      // БОЛГРАДСЬКИЙ РАЙОН
      { id: 23, name: 'КНП "Бессарабська багатопрофільна лікарня"', shortName: 'Бессарабська лікарня', district: 'Болградський', type: 'Селищна лікарня', hasElectricity: true, alternativePower: 'Дизель-генератор', fuelReserve: '7 діб', heating: 'власна котельня', water: 'централізоване', waterReserve: '3000 л', communication: 'Не порушений', damages: 'немає', contact: 'Ротар С.І. 0982674276', lat: 46.1865, lng: 29.1501 },
      // РОЗДІЛЬНЯНСЬКИЙ РАЙОН
      { id: 14, name: 'КНП "Роздільнянська багатопрофільна лікарня"', shortName: 'Роздільнянська лікарня', district: 'Роздільнянський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератори, сонячні панелі', fuelReserve: '7 діб', heating: 'централізоване, наявне', water: 'централізоване + свердловина', waterReserve: '6000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Осипов В.О. 0669244340', lat: 46.8461, lng: 30.0828 },
      { id: 17, name: 'КНП "Захарівська багатопрофільна лікарня"', shortName: 'Захарівська лікарня', district: 'Роздільнянський', type: 'Сільська лікарня', hasElectricity: true, alternativePower: 'Генератори, сонячні панелі', fuelReserve: '7 діб', heating: 'власна котельня', water: 'централізоване', waterReserve: '5000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Ганзій А.М 0507247345', lat: 47.1167, lng: 30.0833 },
      { id: 37, name: 'КНП "Цебриківський центр ПМСД"', shortName: 'Цебриківський ЦПМСД', district: 'Роздільнянський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори (1 з 2)', fuelReserve: '7 днів', heating: 'власна котельня (газ)', water: 'власна свердловина', waterReserve: 'Є', communication: 'Є', damages: 'ні', contact: 'Платонова Л.В. 0967459159', lat: 47.0500, lng: 30.0667 },
      { id: 38, name: 'КНП "Захарівський центр ПМСД"', shortName: 'Захарівський ЦПМСД', district: 'Роздільнянський', type: 'ЦПМСД', hasElectricity: false, alternativePower: 'Генератор, сонячні панелі 7 кВт', fuelReserve: '5 днів', heating: 'власна котельня', water: 'централізоване', waterReserve: '400 л', communication: 'Є', damages: 'ні', contact: '', lat: 46.6167, lng: 29.9000 },
      { id: 39, name: 'КНП "Дивізійський центр ПМСД"', shortName: 'Дивізійський ЦПМСД', district: 'Роздільнянський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '10 днів', heating: 'власна котельня', water: 'наявне', waterReserve: '20 діб', communication: 'Є', damages: 'ні', contact: 'Бакуменко Л. 0682726947', lat: 46.9000, lng: 29.8167 },
      // ПОДІЛЬСЬКИЙ РАЙОН
      { id: 9, name: 'КП "Балтська багатопрофільна лікарня"', shortName: 'Балтська лікарня', district: 'Подільський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератори, сонячна станція, ДБЖ', fuelReserve: '10 діб', heating: 'власна котельня', water: 'свердловина', waterReserve: '20000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Кацмаза Роман 0952284517', lat: 47.9361, lng: 29.6233 },
      { id: 13, name: 'КНП "Подільська міська лікарня"', shortName: 'Подільська лікарня', district: 'Подільський', type: 'Міська лікарня', hasElectricity: false, alternativePower: 'Генератори, сонячні панелі, акумулятори', fuelReserve: '7 діб', heating: 'власна котельня', water: 'централізоване', waterReserve: '6000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Літянський Дмитро 0984842595', lat: 47.7494, lng: 29.5300 },
      { id: 18, name: 'КНП "Любашівська багатопрофільна лікарня"', shortName: 'Любашівська лікарня', district: 'Подільський', type: 'Сільська лікарня', hasElectricity: true, alternativePower: 'Генератори, сонячні панелі, акумулятори', fuelReserve: '7 діб', heating: 'власна котельня', water: 'власна свердловина', waterReserve: '5000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Фомін Дмитро 0674896441', lat: 47.8389, lng: 30.2611 },
      { id: 19, name: 'КНП "Кодимська лікарня"', shortName: 'Кодимська лікарня', district: 'Подільський', type: 'Міська лікарня', hasElectricity: true, alternativePower: 'Генератори, сонячні панелі, ДБЖ', fuelReserve: '20 днів', heating: 'альтернативне', water: 'свердловина + централізоване', waterReserve: '5000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Волошина Лариса 0967229937', lat: 48.1033, lng: 29.1208 },
      { id: 21, name: 'КНП "ЦРЛ Подільського району"', shortName: 'ЦРЛ Подільського р-ну', district: 'Подільський', type: 'ЦРЛ', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '20 днів', heating: 'централізоване', water: 'централізоване', waterReserve: '7000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Качан О.М. 0953204308', lat: 47.4167, lng: 29.5500 },
      { id: 22, name: 'КНП "Савранська лікарня"', shortName: 'Савранська лікарня', district: 'Подільський', type: 'Селищна лікарня', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '5 діб', heating: 'власна котельня', water: 'централізоване + свердловина', waterReserve: '1000 л', communication: 'Мобільний', damages: 'відсутні', contact: 'Ткач Станіслав 0679422414', lat: 48.1331, lng: 30.0836 },
      { id: 35, name: 'КНП "ЦПМСД Куяльницької сільської ради"', shortName: 'Куяльницький ЦПМСД', district: 'Подільський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '5 днів', heating: 'централізоване (ні)', water: 'централізоване (так)', waterReserve: '2205 л', communication: 'Наявний', damages: 'відсутні', contact: 'Серединська Т.В. 0668838347', lat: 47.3333, lng: 29.6833 },
      { id: 36, name: 'КНП "ЦПМСД Подільської міської ради"', shortName: 'Подільський ЦПМСД', district: 'Подільський', type: 'ЦПМСД', hasElectricity: true, alternativePower: 'Генератори', fuelReserve: '7 діб', heating: 'котельня', water: 'централізоване', waterReserve: '2000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Мемей Л.О. 0957166223', lat: 47.7556, lng: 29.5389 },
      // БЕРЕЗІВСЬКИЙ РАЙОН
      { id: 10, name: 'КНП "Березівська центральна міська лікарня"', shortName: 'Березівська лікарня', district: 'Березівський', type: 'Міська лікарня', hasElectricity: false, alternativePower: 'Генератор, сонячні батареї', fuelReserve: '10 діб', heating: 'власна котельня', water: 'свердловина', waterReserve: '25000 л', communication: 'Наявний', damages: 'відсутні', contact: 'Алейнов Олександр 0688730373', lat: 47.1914, lng: 30.9161 },
      { id: 24, name: 'КНП "Іванівський медичний центр"', shortName: 'Іванівський мед. центр', district: 'Березівський', type: 'Селищний центр', hasElectricity: true, alternativePower: 'Генератори, Tesla', fuelReserve: '5 днів', heating: 'альтернативне', water: 'альтернативне', waterReserve: '8000 л', communication: 'Є', damages: 'відсутні', contact: 'Мацкул Галина 0505170002', lat: 47.2833, lng: 30.7167 }
    ];
    
    let map, markers = [], districtLayers = [], districtLabels = [], currentFilter = 'all', selectedFacilityId = null, currentTheme = 'dark', tileLayer = null;
    let showDistrictColors = true;
    
    const tileLayers = { dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png' };
    
    function setTheme(theme) {
      currentTheme = theme;
      document.body.setAttribute('data-theme', theme);
      document.getElementById('darkBtn').classList.toggle('active', theme === 'dark');
      document.getElementById('lightBtn').classList.toggle('active', theme === 'light');
      localStorage.setItem('mapTheme', theme);
      if (tileLayer) map.removeLayer(tileLayer);
      tileLayer = L.tileLayer(tileLayers[theme], { attribution: '&copy; OSM &copy; CARTO' }).addTo(map);
      drawDistrictPolygons();
      updateMarkers();
    }
    
    function toggleDistrictColors() {
      showDistrictColors = !showDistrictColors;
      document.getElementById('colorBtn').classList.toggle('active-orange', showDistrictColors);
      drawDistrictPolygons();
    }
    
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      if (tabName === 'districts') {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('tabDistricts').classList.add('active');
      } else {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tabFacilities').classList.add('active');
      }
    }
    
    function initMap() {
      const savedTheme = localStorage.getItem('mapTheme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      currentTheme = savedTheme;
      document.getElementById('darkBtn').classList.toggle('active', savedTheme === 'dark');
      document.getElementById('lightBtn').classList.toggle('active', savedTheme === 'light');
      map = L.map('map', { center: [46.2, 29.5], zoom: 7, zoomControl: false });
      tileLayer = L.tileLayer(tileLayers[savedTheme], { attribution: '&copy; OSM &copy; CARTO' }).addTo(map);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      drawDistrictPolygons();
      updateMarkers();
      populateDistricts();
      updateStats();
      renderFacilityList();
      renderDistrictOverview();
      if (CONFIG.USE_GOOGLE_SHEETS) { loadFromGoogleSheets(); setInterval(loadFromGoogleSheets, CONFIG.REFRESH_INTERVAL); }
    }
    
    function drawDistrictPolygons() {
      districtLayers.forEach(l => map.removeLayer(l));
      districtLabels.forEach(l => map.removeLayer(l));
      districtLayers = [];
      districtLabels = [];
      
      Object.keys(districtPolygons).forEach(districtName => {
        const polygon = districtPolygons[districtName];
        const status = districtPowerStatus[districtName];
        const color = districtColors[status];
        
        const layer = L.geoJSON({
          type: 'Feature',
          properties: { name: districtName, status: status },
          geometry: polygon
        }, {
          style: {
            fillColor: showDistrictColors ? color : 'transparent',
            fillOpacity: showDistrictColors ? 0.35 : 0,
            color: color,
            weight: 3,
            opacity: 0.9
          }
        });
        
        layer.on('click', () => {
          document.getElementById('districtSelect').value = districtName;
          filterFacilities();
          switchTab('facilities');
          const info = districtInfo[districtName];
          if (info) map.flyTo(info.center, info.zoom, { duration: 0.8 });
        });
        layer.on('mouseover', (e) => { e.target.setStyle({ fillOpacity: showDistrictColors ? 0.5 : 0.2, weight: 4 }); });
        layer.on('mouseout', (e) => { e.target.setStyle({ fillOpacity: showDistrictColors ? 0.35 : 0, weight: 3 }); });
        layer.bindTooltip(`<strong>${districtName} район</strong><br>${districtStatusLabels[status]}<br>${districtInfo[districtName].population}`, {
          permanent: false, direction: 'center', className: 'district-tooltip'
        });
        layer.addTo(map);
        districtLayers.push(layer);
        
        const info = districtInfo[districtName];
        if (info && info.labelPos) {
          const label = L.marker(info.labelPos, {
            icon: L.divIcon({
              className: 'district-label',
              html: `<div style="text-align:center;"><strong>${districtName}</strong></div>`,
              iconSize: [140, 20],
              iconAnchor: [70, 10]
            })
          });
          label.addTo(map);
          districtLabels.push(label);
        }
      });
    }
    
    function renderDistrictOverview() {
      const container = document.getElementById('districtOverview');
      const districts = Object.keys(districtInfo).sort((a, b) => {
        const order = { 'yes': 0, 'partial': 1, 'no': 2 };
        return order[districtPowerStatus[a]] - order[districtPowerStatus[b]];
      });
      container.innerHTML = districts.map(d => {
        const info = districtInfo[d];
        const status = districtPowerStatus[d];
        const facilities = facilitiesData.filter(f => f.district === d);
        const withPower = facilities.filter(f => f.hasElectricity).length;
        const statusClass = status === 'yes' ? 'power-yes' : status === 'partial' ? 'power-partial' : 'power-no';
        return `<div class="district-card" onclick="zoomToDistrict('${d}')">
          <div class="district-card-header">
            <div class="district-card-name">${d}</div>
            <div class="district-card-status ${statusClass}"><div class="dot"></div>${districtStatusLabels[status]}</div>
          </div>
          <div class="district-card-stats">
            <span>👥 ${info.population}</span>
            <span>🏥 ${facilities.length}</span>
            <span>⚡ ${withPower}/${facilities.length}</span>
          </div>
        </div>`;
      }).join('');
    }
    
    function zoomToDistrict(districtName) {
      const info = districtInfo[districtName];
      if (info) {
        map.flyTo(info.center, info.zoom, { duration: 0.8 });
        document.getElementById('districtSelect').value = districtName;
        filterFacilities();
        switchTab('facilities');
      }
    }
    
    function createMarkerIcon(hasElectricity, isSelected = false) {
      const color = hasElectricity ? '#22c55e' : '#ef4444';
      const borderColor = isSelected ? '#fbbf24' : (currentTheme === 'dark' ? '#1e293b' : '#ffffff');
      const size = isSelected ? 28 : 22;
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="width:${size}px;height:${size}px;background:${color};border:3px solid ${borderColor};border-radius:50%;box-shadow:0 3px 12px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center"><svg width="${size*0.5}px" height="${size*0.5}px" viewBox="0 0 24 24" fill="white">${hasElectricity?'<path d="M13 3L4 14h7l-2 7 9-11h-7l2-7z"/>':'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill-opacity="0.3"/><line x1="4" y1="4" x2="20" y2="20" stroke="white" stroke-width="2"/>'}</svg></div>`,
        iconSize: [size, size], iconAnchor: [size/2, size/2], popupAnchor: [0, -size/2]
      });
    }
    
    function updateMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      getFilteredFacilities().forEach(f => {
        const marker = L.marker([f.lat, f.lng], { icon: createMarkerIcon(f.hasElectricity, selectedFacilityId === f.id) });
        marker.bindPopup(`<div class="popup-title">${f.shortName}</div><div class="popup-district">${f.district} район</div><div class="popup-status ${f.hasElectricity?'on':'off'}"><span></span>${f.hasElectricity?'Є електропостачання':'Без електропостачання'}</div>`);
        marker.on('click', () => showDetail(f.id));
        marker.addTo(map);
        markers.push(marker);
      });
    }
    
    function getFilteredFacilities() {
      let result = [...facilitiesData];
      if (currentFilter === 'on') result = result.filter(f => f.hasElectricity);
      else if (currentFilter === 'off') result = result.filter(f => !f.hasElectricity);
      const district = document.getElementById('districtSelect').value;
      if (district) result = result.filter(f => f.district === district);
      const search = document.getElementById('searchInput').value.toLowerCase();
      if (search) result = result.filter(f => f.name.toLowerCase().includes(search) || f.shortName.toLowerCase().includes(search) || f.district.toLowerCase().includes(search));
      return result;
    }
    
    function populateDistricts() {
      const select = document.getElementById('districtSelect');
      Object.keys(districtInfo).sort().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = `${d} (${districtInfo[d].population})`;
        select.appendChild(opt);
      });
      select.addEventListener('change', () => {
        if (select.value && districtInfo[select.value]) {
          const info = districtInfo[select.value];
          map.flyTo(info.center, info.zoom, { duration: 0.8 });
        }
      });
    }
    
    function updateStats() {
      const filtered = getFilteredFacilities();
      document.getElementById('totalCount').textContent = filtered.length;
      document.getElementById('onCount').textContent = filtered.filter(f => f.hasElectricity).length;
      document.getElementById('offCount').textContent = filtered.filter(f => !f.hasElectricity).length;
    }
    
    function setFilter(type) {
      currentFilter = type;
      document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active','active-green','active-red'));
      if (type === 'all') document.getElementById('statAll').classList.add('active');
      else if (type === 'on') document.getElementById('statOn').classList.add('active-green');
      else document.getElementById('statOff').classList.add('active-red');
      filterFacilities();
    }
    
    function filterFacilities() { updateStats(); updateMarkers(); renderFacilityList(); }
    
    function renderFacilityList() {
      const list = document.getElementById('facilityList');
      const filtered = getFilteredFacilities();
      if (!filtered.length) { list.innerHTML = '<div class="empty-state"><div class="icon">🔍</div><div>Закладів не знайдено</div></div>'; return; }
      list.innerHTML = filtered.map(f => `<div class="facility-item" onclick="showDetail(${f.id})">
        <div class="facility-status ${f.hasElectricity?'on':'off'}"></div>
        <div class="facility-info">
          <div class="facility-name">${f.shortName}</div>
          <div class="facility-meta">${f.district} район • ${f.type}</div>
          <div class="facility-tags"><span>⛽ ${f.fuelReserve}</span>${f.heating.includes('котельня')?'<span class="heat">🔥 котельня</span>':''}</div>
        </div>
        <svg class="facility-arrow" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </div>`).join('');
    }
    
    function showDetail(id) {
      const f = facilitiesData.find(x => x.id === id);
      if (!f) return;
      selectedFacilityId = id;
      document.getElementById('facilityList').style.display = 'none';
      document.getElementById('detailView').classList.add('active');
      document.getElementById('detailName').textContent = f.shortName;
      document.getElementById('detailFullName').textContent = f.name;
      document.getElementById('detailStatus').innerHTML = `<div class="status-badge ${f.hasElectricity?'on':'off'}"><div class="status-dot"></div>${f.hasElectricity?'Електропостачання наявне':'Електропостачання відсутнє'}</div>`;
      const rows = [['⚡','Альтернативне живлення',f.alternativePower],['⛽','Запас палива',f.fuelReserve],['🔥','Теплопостачання',f.heating],['💧','Водопостачання',f.water],['🚰','Запас води',f.waterReserve],['📡','Зв\'язок',f.communication],['💥','Пошкодження',f.damages],['📍','Район',f.district],['🏥','Тип',f.type]];
      if (f.contact) rows.push(['📞','Контакт',f.contact]);
      document.getElementById('detailInfo').innerHTML = rows.map(r => `<div class="info-row"><div class="info-icon">${r[0]}</div><div class="info-content"><div class="info-label">${r[1]}</div><div class="info-value">${r[2]}</div></div></div>`).join('');
      map.flyTo([f.lat, f.lng], 14, { duration: 0.8 });
      updateMarkers();
    }
    
    function hideDetail() { selectedFacilityId = null; document.getElementById('facilityList').style.display = 'block'; document.getElementById('detailView').classList.remove('active'); updateMarkers(); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
    
    async function loadFromGoogleSheets() {
      if (!CONFIG.GOOGLE_SHEETS_URL) return;
      try {
        const res = await fetch(CONFIG.GOOGLE_SHEETS_URL);
        const csv = await res.text();
        const data = parseCSV(csv);
        if (data.length) { facilitiesData = data; updateStats(); updateMarkers(); renderFacilityList(); renderDistrictOverview(); document.getElementById('dataSource').querySelector('span').textContent = 'Google Sheets'; }
      } catch(e) { console.error(e); }
    }
    
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      return lines.slice(1).map((line, i) => {
        const v = line.split(',');
        return { id: i+1, name: v[0]||'', shortName: v[1]||v[0]||'', district: v[2]||'', type: v[3]||'', hasElectricity: v[4]?.toLowerCase()==='так'||v[4]?.toLowerCase()==='true', alternativePower: v[5]||'', fuelReserve: v[6]||'', heating: v[7]||'', water: v[8]||'', waterReserve: v[9]||'', communication: v[10]||'', damages: v[11]||'', contact: v[12]||'', lat: parseFloat(v[13])||46.5, lng: parseFloat(v[14])||30.0 };
      }).filter(f => f.name && f.lat && f.lng);
    }
    
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
